<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Accessible Modal Dialog Example</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #ffffff;
      --fg: #111111;
      --overlay: rgba(0, 0, 0, 0.55);
      --panel: #ffffff;
      --border: rgba(0, 0, 0, 0.18);
      --focus: #0b57d0;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f1115;
        --fg: #eef1f6;
        --overlay: rgba(0, 0, 0, 0.7);
        --panel: #171a21;
        --border: rgba(255, 255, 255, 0.16);
        --focus: #7aa2ff;
      }
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--fg);
      line-height: 1.5;
    }

    .container {
      max-width: 60rem;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    button {
      font: inherit;
      border: 1px solid var(--border);
      background: transparent;
      color: inherit;
      padding: 0.6rem 1rem;
      border-radius: 0.6rem;
      cursor: pointer;
    }

    button:hover {
      border-color: color-mix(in srgb, var(--border) 50%, currentColor 30%);
    }

    button:focus-visible,
    input:focus-visible {
      outline: 3px solid var(--focus);
      outline-offset: 2px;
    }

    .primary {
      background: color-mix(in srgb, var(--focus) 20%, transparent);
      border-color: color-mix(in srgb, var(--focus) 55%, var(--border));
    }

    /* Fallback modal for browsers without <dialog> support */
    .modal-fallback[hidden] { display: none; }
    .modal-fallback {
      position: fixed;
      inset: 0;
      background: var(--overlay);
      display: grid;
      place-items: center;
      padding: 1rem;
      z-index: 1000;
    }
    .modal-panel {
      width: min(34rem, 100%);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 0.8rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      padding: 1rem;
    }
    .modal-header {
      display: flex;
      align-items: start;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }
    .modal-title {
      margin: 0;
      font-size: 1.25rem;
      line-height: 1.2;
    }
    .modal-body {
      margin: 0.75rem 0 1rem;
    }
    .modal-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    /* Native dialog styling */
    dialog {
      width: min(34rem, 100%);
      border: 1px solid var(--border);
      border-radius: 0.8rem;
      padding: 1rem;
      background: var(--panel);
      color: inherit;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    dialog::backdrop {
      background: var(--overlay);
    }

    label {
      display: block;
      margin: 0.75rem 0 0.25rem;
    }
    input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 0.6rem 0.75rem;
      border-radius: 0.6rem;
      border: 1px solid var(--border);
      background: transparent;
      color: inherit;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body>
  <main class="container">
    <h1>Modal Dialog Example</h1>
    <p>
      This is an accessible modal dialog. It is closed by default. Use the button below to open it.
    </p>

    <button class="trigger primary" type="button" id="openModal" aria-haspopup="dialog" aria-controls="exampleModal">
      Open modal
    </button>

    <!-- Preferred: native dialog -->
    <dialog id="exampleModal" aria-labelledby="modalTitle" aria-describedby="modalDesc">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Example modal dialog</h2>
        <button type="button" id="closeModalX">
          <span aria-hidden="true">Close</span>
          <span class="sr-only">dialog</span>
        </button>
      </div>

      <p class="modal-body" id="modalDesc">
        This is a modal dialog. Press Escape to close, or use the buttons below.
      </p>

      <form method="dialog">
        <label for="nameInput">Example input</label>
        <input id="nameInput" name="name" type="text" autocomplete="name" />

        <div class="modal-actions" style="margin-top: 1rem;">
          <button value="cancel" id="cancelBtn">Cancel</button>
          <button class="primary" value="confirm" id="confirmBtn">Confirm</button>
        </div>
      </form>
    </dialog>

    <!-- Fallback for older browsers -->
    <div id="modalFallback" class="modal-fallback" hidden role="dialog" aria-modal="true" aria-labelledby="modalTitleFb" aria-describedby="modalDescFb">
      <div class="modal-panel" role="document">
        <div class="modal-header">
          <h2 class="modal-title" id="modalTitleFb">Example modal dialog</h2>
          <button type="button" id="closeFallbackX">
            <span aria-hidden="true">Close</span>
            <span class="sr-only">dialog</span>
          </button>
        </div>

        <p class="modal-body" id="modalDescFb">
          This is a modal dialog. Press Escape to close, or use the buttons below.
        </p>

        <label for="nameInputFb">Example input</label>
        <input id="nameInputFb" type="text" autocomplete="name" />

        <div class="modal-actions" style="margin-top: 1rem;">
          <button type="button" id="cancelFallback">Cancel</button>
          <button type="button" class="primary" id="confirmFallback">Confirm</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    (function () {
      const trigger = document.querySelector('.trigger');
      const dialog = document.getElementById('exampleModal');
      const closeX = document.getElementById('closeModalX');

      const fallback = document.getElementById('modalFallback');
      const closeFallbackX = document.getElementById('closeFallbackX');
      const cancelFallback = document.getElementById('cancelFallback');
      const confirmFallback = document.getElementById('confirmFallback');

      let lastFocused = null;

      function supportsDialog() {
        return typeof HTMLDialogElement === 'function' && typeof dialog.showModal === 'function';
      }

      function openModal() {
        lastFocused = document.activeElement;
        if (supportsDialog()) {
          dialog.showModal();
          // Focus a meaningful control
          const focusTarget = dialog.querySelector('#nameInput') || dialog.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
          if (focusTarget) focusTarget.focus();
        } else {
          fallback.hidden = false;
          document.body.style.overflow = 'hidden';
          const focusTarget = document.getElementById('nameInputFb');
          if (focusTarget) focusTarget.focus();
        }
        trigger.setAttribute('aria-expanded', 'true');
      }

      function closeModal(returnFocus = true) {
        if (supportsDialog()) {
          if (dialog.open) dialog.close();
        } else {
          fallback.hidden = true;
          document.body.style.overflow = '';
        }
        trigger.setAttribute('aria-expanded', 'false');
        if (returnFocus && lastFocused && typeof lastFocused.focus === 'function') lastFocused.focus();
      }

      // Open via trigger
      trigger.addEventListener('click', openModal);

      // Close button in native dialog
      closeX.addEventListener('click', () => closeModal(true));

      // Native dialog: restore focus when closed by Esc or form submit
      dialog.addEventListener('close', () => closeModal(true));

      // Fallback close controls
      closeFallbackX.addEventListener('click', () => closeModal(true));
      cancelFallback.addEventListener('click', () => closeModal(true));
      confirmFallback.addEventListener('click', () => closeModal(true));

      // Click outside panel to close (fallback only)
      fallback.addEventListener('click', (e) => {
        if (e.target === fallback) closeModal(true);
      });

      // Escape to close (fallback only)
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !supportsDialog() && !fallback.hidden) {
          e.preventDefault();
          closeModal(true);
        }
      });

      // Minimal focus trap for fallback
      function getFocusable(container) {
        return Array.from(container.querySelectorAll(
          'a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
        )).filter(el => el.offsetParent !== null);
      }

      fallback.addEventListener('keydown', (e) => {
        if (fallback.hidden) return;
        if (e.key !== 'Tab') return;

        const focusables = getFocusable(fallback);
        if (focusables.length === 0) return;

        const first = focusables[0];
        const last = focusables[focusables.length - 1];

        if (e.shiftKey && document.activeElement === first) {
          e.preventDefault();
          last.focus();
        } else if (!e.shiftKey && document.activeElement === last) {
          e.preventDefault();
          first.focus();
        }
      });

      // Initialize aria-expanded (closed by default)
      trigger.setAttribute('aria-expanded', 'false');
    })();
  </script>
</body>
</html>