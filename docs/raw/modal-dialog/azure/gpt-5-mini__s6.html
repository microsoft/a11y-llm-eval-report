<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Accessible Modal Dialog Example</title>
  <style>
    :root {
      --overlay-bg: rgba(0,0,0,0.6);
      --panel-bg: #fff;
      --panel-radius: 8px;
      --max-width: 640px;
      --spacing: 1rem;
      --focus: 3px solid #66afe9;
      --transition: 200ms ease;
    }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      line-height: 1.4;
      margin: 0;
      padding: 2rem;
      color: #222;
    }

    /* Demo page */
    header {
      margin-bottom: 1.5rem;
    }

    button.trigger {
      background: #0366d6;
      color: white;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
    }
    button.trigger:focus {
      outline: none;
      box-shadow: var(--focus);
    }

    /* Modal base: hidden by default using aria-hidden */
    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      pointer-events: none; /* disabled when hidden */
    }
    .modal[aria-hidden="true"] {
      visibility: hidden;
      opacity: 0;
      pointer-events: none;
    }
    .modal[aria-hidden="false"] {
      visibility: visible;
      opacity: 1;
      pointer-events: auto;
      transition: opacity var(--transition);
    }

    /* Overlay */
    .modal__overlay {
      position: absolute;
      inset: 0;
      background: var(--overlay-bg);
      opacity: 0;
      transition: opacity var(--transition);
    }
    .modal[aria-hidden="false"] .modal__overlay {
      opacity: 1;
    }

    /* Panel */
    .modal__panel {
      position: relative;
      background: var(--panel-bg);
      width: calc(100% - 2rem);
      max-width: var(--max-width);
      margin: 1rem;
      border-radius: var(--panel-radius);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      transform: translateY(-12px) scale(0.995);
      opacity: 0;
      transition: transform var(--transition), opacity var(--transition);
      z-index: 1;
      pointer-events: auto;
    }
    .modal[aria-hidden="false"] .modal__panel {
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    .modal__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: calc(var(--spacing) * 0.75) var(--spacing);
      border-bottom: 1px solid #eee;
    }
    .modal__title {
      margin: 0;
      font-size: 1.125rem;
    }

    .modal__body {
      padding: var(--spacing);
      font-size: 0.98rem;
    }

    .modal__footer {
      padding: calc(var(--spacing) * 0.75) var(--spacing);
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      border-top: 1px solid #eee;
    }

    /* Buttons */
    .btn {
      border: none;
      padding: 0.5rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
    }
    .btn.primary {
      background: #0366d6;
      color: white;
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid #ddd;
    }
    .btn:focus {
      outline: none;
      box-shadow: var(--focus);
    }

    /* Close icon button */
    .modal__close {
      background: transparent;
      border: none;
      font-size: 1.25rem;
      line-height: 1;
      padding: 0.25rem;
      border-radius: 6px;
      cursor: pointer;
    }
    .modal__close:focus {
      outline: none;
      box-shadow: var(--focus);
    }

    /* Small utilities */
    .sr-only {
      position: absolute !important;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0 0 0 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>Modal Dialog Component</h1>
    <p>
      Example of an accessible modal dialog that is closed by default. Use the button below to open it.
    </p>
    <button class="trigger" type="button" aria-haspopup="dialog">Open modal</button>
  </header>

  <main id="main-content">
    <section>
      <h2>Page content</h2>
      <p>
        This is background content that should not be interactable when the modal is open.
      </p>
      <p>
        There is a second trigger as well for demonstration:
        <button class="trigger" type="button">Also open modal</button>
      </p>
    </section>
  </main>

  <!-- Modal: closed by default (aria-hidden="true") -->
  <div id="example-modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="modal-title">
    <div class="modal__overlay" data-close></div>

    <div class="modal__panel" role="document">
      <div class="modal__header">
        <h3 id="modal-title" class="modal__title">Example modal</h3>
        <button class="modal__close" aria-label="Close dialog" data-close>&times;</button>
      </div>

      <div class="modal__body">
        <p>
          This is a simple modal dialog. It traps focus while open, can be dismissed with the Escape key,
          clicking the overlay, or the close button. Focus returns to the trigger that opened it when closed.
        </p>

        <p>
          Focusable elements inside the dialog:
        </p>
        <ul>
          <li><a href="#" id="help-link">Help link</a></li>
          <li><button class="btn primary">Primary action</button></li>
        </ul>
      </div>

      <div class="modal__footer">
        <button class="btn ghost" type="button" data-close>Cancel</button>
        <button class="btn primary" type="button" id="save-button">Save</button>
      </div>
    </div>
  </div>

  <script>
    (function() {
      const modal = document.getElementById('example-modal');
      const triggers = Array.from(document.querySelectorAll('.trigger'));
      const mainContent = document.getElementById('main-content');
      const focusableSelectors = [
        'a[href]',
        'area[href]',
        'input:not([disabled]):not([type="hidden"])',
        'select:not([disabled])',
        'textarea:not([disabled])',
        'button:not([disabled])',
        'iframe',
        'object',
        'embed',
        '[contenteditable]',
        '[tabindex]:not([tabindex^="-"])'
      ].join(',');
      let lastFocusedElement = null;
      let focusableElements = [];
      let firstFocusable = null;
      let lastFocusable = null;
      let boundKeyHandler = null;

      // Open modal
      function openModal(trigger) {
        lastFocusedElement = trigger || document.activeElement;
        modal.setAttribute('aria-hidden', 'false');

        // Optionally mark background as inert (not widely supported). We add aria-hidden.
        mainContent.setAttribute('aria-hidden', 'true');

        // Prevent body scroll
        document.body.style.overflow = 'hidden';

        // collect focusable elements inside modal
        focusableElements = Array.from(modal.querySelectorAll(focusableSelectors));
        if (focusableElements.length === 0) {
          // if nothing focusable, focus the dialog panel
          const panel = modal.querySelector('.modal__panel');
          panel.setAttribute('tabindex', '-1');
          panel.focus();
          firstFocusable = lastFocusable = panel;
        } else {
          firstFocusable = focusableElements[0];
          lastFocusable = focusableElements[focusableElements.length - 1];
          // Move focus into the modal - focus the first focusable element
          window.setTimeout(() => firstFocusable.focus(), 10);
        }

        // Handle key events for ESC and Tab trap
        boundKeyHandler = handleKeyDown;
        document.addEventListener('keydown', boundKeyHandler);
      }

      // Close modal
      function closeModal() {
        modal.setAttribute('aria-hidden', 'true');
        mainContent.removeAttribute('aria-hidden');
        document.body.style.overflow = '';
        document.removeEventListener('keydown', boundKeyHandler);
        boundKeyHandler = null;

        // return focus to the element that triggered the modal
        if (lastFocusedElement && typeof lastFocusedElement.focus === 'function') {
          lastFocusedElement.focus();
        }
      }

      // Toggle (not used directly, but handy)
      function toggleModal(trigger) {
        if (modal.getAttribute('aria-hidden') === 'true') {
          openModal(trigger);
        } else {
          closeModal();
        }
      }

      // Handle keydown events when modal is open
      function handleKeyDown(e) {
        if (e.key === 'Escape' || e.key === 'Esc') {
          e.preventDefault();
          closeModal();
          return;
        }

        if (e.key === 'Tab') {
          // Ensure focus trapping
          if (focusableElements.length === 0) {
            // No focusable children, keep focus on panel
            e.preventDefault();
            return;
          }

          const active = document.activeElement;
          if (e.shiftKey) {
            // shift + tab
            if (active === firstFocusable || active === modal) {
              e.preventDefault();
              lastFocusable.focus();
            }
          } else {
            // tab
            if (active === lastFocusable) {
              e.preventDefault();
              firstFocusable.focus();
            }
          }
        }
      }

      // Click handlers: open buttons
      triggers.forEach(btn => {
        btn.addEventListener('click', (e) => {
          openModal(btn);
        });
      });

      // Close on overlay click or elements with data-close attribute
      modal.addEventListener('click', (e) => {
        // If clicked overlay or an element with data-close, close the modal
        if (e.target.closest('[data-close]') || e.target === modal) {
          closeModal();
        }
      });

      // Accessibility: if focus somehow leaves the modal while it's open, bring it back
      document.addEventListener('focusin', (e) => {
        if (modal.getAttribute('aria-hidden') === 'false') {
          if (!modal.contains(e.target)) {
            // Focus moved outside modal -> move it back to first focusable
            (firstFocusable || modal.querySelector('.modal__panel')).focus();
          }
        }
      });

      // Example: save button does something and closes modal
      const saveButton = document.getElementById('save-button');
      saveButton.addEventListener('click', () => {
        // perform some action (demo)
        alert('Saved!');
        closeModal();
      });

      // Close on initial load when JavaScript is available ensures modal remains hidden
      // (modal initial state is aria-hidden="true" in markup)
    })();
  </script>
</body>
</html>